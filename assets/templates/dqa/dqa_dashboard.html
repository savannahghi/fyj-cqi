{% extends 'dqa/index_dqa.html' %}
{% load crispy_forms_tags %}
{% load static %}
{% load mathfilters %}


{% block content %}
    <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
        <h6 class="display-6 text-primary text-center">DQA DASHBOARD</h6>
        <hr>
        <div class="p-5 mb-4 bg-light rounded-3">
            {% if messages %}
                {% for message in messages %}
                    <div class="alert alert-info col-12" role="alert">
                        <h5 class="small">{{ message }}</h5>
                    </div>
                {% endfor %}
            {% endif %}
            {% if "facility" in title %}
                <h6 class="display-6 fw-bold text-primary">CREATE FACILITY QI</h6>
            {% elif "program" in title %}
                <h6 class="display-6 fw-bold text-primary">CREATE {{ title|upper }} QI</h6>
            {% endif %}
            <div class="d-flex justify-content-around mb-3">
                {% if dqa_type == "hub" %}
                    <a href="{% url 'dqa_dashboard' dqa_type='hub' %}" class="btn btn-success">HUB DQA</a>
                {% else %}
                    <a href="{% url 'dqa_dashboard' dqa_type='hub' %}" class="btn btn-outline-success">HUB DQA</a>
                {% endif %}
                {% if dqa_type == "subcounty" %}
                    <a href="{% url 'dqa_dashboard' dqa_type='subcounty' %}" class="btn btn-success">SUB-COUNTIES
                        DQA</a>
                {% else %}
                    <a href="{% url 'dqa_dashboard' dqa_type='subcounty' %}" class="btn btn-outline-success">SUB-COUNTIES
                        DQA</a>
                {% endif %}
                {% if dqa_type == "county" %}
                    <a href="{% url 'dqa_dashboard' dqa_type='county' %}" class="btn btn-success">COUNTY DQA</a>
                {% else %}
                    <a href="{% url 'dqa_dashboard' dqa_type='county' %}" class="btn btn-outline-success">COUNTY DQA</a>
                {% endif %}
                {% if dqa_type == "program" %}
                    <a href="{% url 'dqa_dashboard' dqa_type='program' %}" class="btn btn-success">PROGRAM DQA</a>
                {% else %}
                    <a href="{% url 'dqa_dashboard' dqa_type='program' %}" class="btn btn-outline-success">PROGRAM
                        DQA</a>
                {% endif %}
            </div>
            <form class="row g-3" method="POST" class="mt-5" enctype='multipart/form-data' autocomplete="off">
                {% csrf_token %}
                <p> Please choose quarter, year and then submit </p>

                <div class="col-md-3 mt-2">
                    {{ quarter_form.quarter|as_crispy_field }}
                </div>
                <div class="col-md-3 mt-2 pr-5">
                    {{ year_form.year|as_crispy_field }}
                </div>
                {% if dqa_type == "subcounty" %}
                    <div class="col-md-4 mt-2">
                        {{ subcounty_form.subcounty |as_crispy_field }}
                    </div>
                {% elif dqa_type == "county" %}
                    <div class="col-md-4 mt-2">
                        {{ county_form.county |as_crispy_field }}
                    </div>
                {% elif dqa_type == "hub" %}
                    <div class="col-md-4 mt-2">
                        {{ hub_form.hub |as_crispy_field }}
                    </div>
                {% elif dqa_type == "program" %}
                    <div class="col-md-4 mt-2">
                        {{ program_form.program |as_crispy_field }}
                    </div>
                {% endif %}
                <div class="col-md-2 mt-2 pt-3">
                    <input class="btn btn-success mt-1" type="submit" value="Submit">
                </div>
            </form>

            {% if viz %}
                <hr>
                <h6 class="text-primary text-center">{{ quarter_year }} Overall DQA Activities</h6>
                <hr>
                <div class="col-md-12 d-flex">
                    <div class="col-md-4">
                        {{ county_viz|safe }}
                    </div>
                    <div class="col-md-8">
                        {{ hub_viz|safe }}
                    </div>
                </div>
                <div class="col mt-3">
                    {{ sub_county_viz|safe }}
                </div>
                <div class="col mt-3">
                    {{ viz|safe }}
                </div>
            {% endif %}
            {% if charts %}
                <hr>
                <h6 class="text-primary text-center">System Assessment</h6>
                <hr>
                <div class="col mt-3">
                    <table class="table table-striped table-hover" style="font-size: x-small;">
                        <thead class="thead-dark text-center">
                        <tr>
                            <th colspan="2">COLOUR CODE KEY</th>
                        </tr>
                        <tr>
                            <th>Color code</th>
                            <th>Range</th>
                        </tr>
                        </thead>
                        <tbody>

                        <tr>
                            <td class="text-center text-black"
                                style="background-color: green; border: 1px solid black;">
                                <strong>Green <span class="text-info"> (Meets standard)</span></strong>
                            </td>
                            <td class="text-primary text-center">
                                <strong> >= 2.5</strong>
                            </td>
                        </tr>
                        <tr>
                            <td class="text-center text-black"
                                style="background-color: yellow; border: 1px solid black;">
                                <strong>Yellow <span class="text-info"> (Needs improvement)</span></strong>
                            </td>
                            <td class="text-primary text-center">
                                <strong> >= 1.5 and < 2.5</strong>
                            </td>

                        <tr>
                            <td class="text-center text-black" style="background-color: red; border: 1px solid black;">
                                <strong>Red <span class="text-info"> (Needs urgent remediation)</span></strong>
                            </td>
                            <td class="text-primary text-center">
                                <strong> < 1.5</strong>
                            </td>
                        </tr>
                        </tr>
                        </tbody>
                    </table>
                    {{ system_assessment_viz|safe }}
                </div>
                {% for chart in charts %}
                    <div class="col mt-3">
                        {{ chart|safe }}
                    </div>

                {% endfor %}
                <div>
                    {{ all_dfs_viz|safe }}
                </div>

                {% if not yellow.empty %}
                    <div>
                        <a class="btn btn-warning mt-3" data-bs-toggle="collapse" href="#collapseyellowscores"
                           role="button"
                           aria-expanded="false" aria-controls="collapseyellowscores">
                            Details of the yellow scores
                            <span class="badge bg-secondary" data-bs-toggle="tooltip"
                                  title="Number of YELLOW scores. Click to view">{{ yellow|length }}</span>
                        </a>
                    </div>
                    <div class="collapse bg-light mt-2" id="collapseyellowscores">
                        <div>
                            {{ yellow_viz_comp|safe }}
                            {{ yellow_viz_quest|safe }}
                        </div>
                        <div>
                            <a class="btn btn-info mt-3" data-bs-toggle="collapse" href="#collapseyellowscoreslinelist"
                               role="button"
                               aria-expanded="false" aria-controls="collapseyellowscoreslinelist"
                               style="font-size: xx-small">
                                Linelist of yellow scores
                            </a>
                        </div>
                        <div class="collapse bg-light mt-2" id="collapseyellowscoreslinelist">
                            <div class="mt-3">
                                {% for keys, df in non_performance_df.items %}
                                    {% if keys == "yellow" %}
                                        <table class="table table-striped table-hover">
                                            <thead class="thead-dark">
                                            <th scope="col"></th>
                                            {% for col in df.columns %}
                                                <th scope="col">{{ col }}</th>
                                            {% endfor %}
                                            </thead>
                                            <tbody>
                                            </tr>
                                            {% for index, row in df.iterrows %}
                                                <tr>
                                                    <th scope="row">{{ index|add:"1" }}</th>
                                                    {% for cell in row %}
                                                        {% if cell == 2 %}
                                                            <td class="align-middle text-center"
                                                                style="background-color: {% if cell == 2 %}yellow{% else %}{% endif %}">
                                                                {% else %}
                                                            <td class="align-middle text-left">
                                                        {% endif %}
                                                    {{ cell }}
                                                    </td>
                                                    {% endfor %}
                                                </tr>
                                            {% endfor %}
                                            </tbody>
                                        </table>
                                    {% endif %}
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                {% endif %}
                {% if not red.empty %}

                    <div>
                        <a class="btn btn-danger mt-3" data-bs-toggle="collapse" href="#collapseredscores" role="button"
                           aria-expanded="false" aria-controls="collapseredscores">
                            Details of the red scores <span class="badge bg-secondary" data-bs-toggle="tooltip"
                                                            title="Number of RED scores. Click to view">{{ red|length }} </span>
                        </a>
                    </div>
                    <div class="collapse bg-light mt-2" id="collapseredscores">
                        <div class="col-md-12">

                            {{ red_viz_comp|safe }}
                            {{ red_viz_quest|safe }}

                        </div>
                        <div>
                            <a class="btn btn-info mt-3" data-bs-toggle="collapse" href="#collapseredscoreslinelist"
                               role="button"
                               aria-expanded="false" aria-controls="collapseredscoreslinelist"
                               style="font-size: xx-small">
                                Linelist of red scores

                            </a>
                        </div>
                        <div class="collapse bg-light mt-2" id="collapseredscoreslinelist">
                            <div class="mt-3">
                                {% for keys, df in non_performance_df.items %}
                                    {% if keys == "red" %}
                                        <table class="table table-striped table-hover">
                                            <thead class="thead-dark">
                                            <th scope="col"></th>
                                            {% for col in df.columns %}
                                                <th scope="col"> {{ col }} </th>
                                            {% endfor %}
                                            </thead>
                                            <tbody>
                                            </tr>
                                            {% for index, row in df.iterrows %}
                                                <tr>
                                                    <th scope="row">{{ index|add:"1" }}</th>
                                                    {% for cell in row %}
                                                        {% if cell == 1 %}
                                                            <td class="align-middle text-center"
                                                                style="background-color: {% if cell == 1 %}red{% else %}{% endif %}">
                                                                {% else %}
                                                            <td class="align-middle text-left">
                                                        {% endif %}
                                                    {{ cell }}
                                                    </td>
                                                    {% endfor %}
                                                </tr>
                                            {% endfor %}
                                            </tbody>
                                        </table>
                                    {% endif %}
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                {% endif %}
                {% if not blue.empty %}
                    <div>
                        <a class="btn btn-primary mt-3 mb-3" data-bs-toggle="collapse" href="#collapsebluescores"
                           role="button"
                           aria-expanded="false" aria-controls="collapsebluescores">
                            Details of the not applicable scores <span class="badge bg-secondary"
                                                                       data-bs-toggle="tooltip"
                                                                       title="Number of not applicable scores. Click to view"> {{ blue|length }} </span>
                        </a>
                    </div>
                    <div class="collapse bg-light mt-2" id="collapsebluescores">
                        <div>
                            {{ blue_viz_comp|safe }}
                            {{ blue_viz_quest|safe }}
                        </div>
                        <div>
                            <a class="btn btn-info mt-3 justify-content-end" data-bs-toggle="collapse"
                               href="#collapsebluescoreslinelist"
                               role="button"
                               aria-expanded="false" aria-controls="collapsebluescoreslinelist"
                               style="font-size: xx-small">
                                Linelist of not applicable scores
                            </a>
                        </div>
                        <div class="collapse bg-light mt-2" id="collapsebluescoreslinelist">
                            <div class="mt-3">
                                {% for keys, df in non_performance_df.items %}
                                    {% if keys == "blue" %}
                                        <table class="table table-striped table-hover">
                                            <thead class="thead-dark">
                                            <th scope="col"></th>
                                            {% for col in df.columns %}
                                                <th scope="col"> {{ col }} </th>
                                            {% endfor %}
                                            </thead>
                                            <tbody>
                                            </tr>
                                            {% for index, row in df.iterrows %}
                                                <tr>
                                                    <th scope="row">{{ index|add:"1" }}</th>
                                                    {% for cell in row %}
                                                        {% if cell == 0 %}
                                                            <td class="align-middle text-center"
                                                                style="background-color: {% if cell == 0 %}blue{% else %}{% endif %}">
                                                                {% else %}
                                                            <td class="align-middle text-left">
                                                        {% endif %}
                                                    {{ cell }}
                                                    </td>
                                                    {% endfor %}
                                                </tr>
                                            {% endfor %}
                                            </tbody>
                                        </table>
                                    {% endif %}
                                {% endfor %}
                            </div>
                        </div>

                    </div>
                {% endif %}
            {% endif %}

            {% if dicts %}
                <hr>
                <h6 class="text-primary text-center">Data Verification</h6>
                <hr>
                {% if data_verification_viz %}


                    <div class="col mt-3">
                        <table class="table table-striped table-hover" style="font-size: x-small;">
                            <thead class="thead-dark text-center">
                            <tr>
                                <th colspan="2">COLOUR CODE KEY</th>
                            </tr>
                            <tr>
                                <th>Color code</th>
                                <th>Absolute difference proportion <span style="font-size: xx-small">(source: SIMS 4.1)</span></th>
                            </tr>
                            </thead>
                            <tbody>

                            <tr>
                                <td class="text-center text-black"
                                    style="background-color: green; border: 1px solid black;">
                                    <strong>Green <span class="text-info"> (Meets standard)</span></strong>
                                </td>
                                <td class="text-primary text-center">
                                    <strong> <= 5% </strong>
                                </td>
                            </tr>
                            <tr>
                                <td class="text-center text-black"
                                    style="background-color: yellow; border: 1px solid black;">
                                    <strong>Yellow <span class="text-info"> (Needs improvement)</span></strong>
                                </td>
                                <td class="text-primary text-center">
                                    <strong> > 5 % and <= 10 % </strong>
                                </td>

                            <tr>
                                <td class="text-center text-black"
                                    style="background-color: red; border: 1px solid black;">
                                    <strong>Red <span class="text-info"> (Needs urgent remediation)</span></strong>
                                </td>
                                <td class="text-primary text-center">
                                    <strong> > 10 % </strong>
                                </td>
                            </tr>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                    <div>
                        {{ data_verification_viz|safe }}
                    </div>
                {% endif %}
                <div class="row">
                    {% if dicts %}
                        <p class="text-center text-primary">
                            The DQA summary charts below are ordered from the indicators with the greatest discrepancies
                            to the least.
                        </p>
                        {% for indicator,fig in dicts.items %}
                            <div class="col-md-4 mt-3">
                                <div class="card">
                                    <div class="col">
                                        <div class="text text-center">
                                            {{ indicator }}
                                        </div>
                                        <div class="row">
                                            <div class="chart-container"> {{ fig|safe }}</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    {% endif %}
                </div>
            {% endif %}
            {% if audit_team %}
                <hr>
                <h6 class="text-primary text-center"> Audit Team </h6>
                <hr>
                <div>
                    {{ audit_viz|safe }}
                </div>
                {% if request.user.is_superuser %}
                    <div>
                        <a class="btn btn-warning mt-3 mb-3" data-bs-toggle="collapse" href="#collapseauditteam"
                           role="button" aria-expanded="false" aria-controls="collapseauditteam">
                            Distribution of audit team
                        </a>
                    </div>
                    <div class="collapse bg-light mt-2" id="collapseauditteam">
                        <div>
                            <table class="table table-striped table-hover">
                                <thead class="thead-dark">
                                <th scope="col"></th>
                                {% for col in audit_team_df.columns %}
                                    <th scope="col">{{ col }}</th>
                                {% endfor %}
                                </thead>
                                <tbody>
                                </tr>
                                {% for index, row in audit_team_df.iterrows %}
                                    <tr>
                                        <th scope="row">{{ index|add:"1" }}</th>
                                        {% for cell in row %}
                                            <td>
                                                {{ cell }}
                                            </td>
                                        {% endfor %}
                                    </tr>
                                {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                {% endif %}
            {% endif %}
            {% if dqa_workplan %}
                <hr>
                <h6 class="text-primary text-center">DQA work-plan</h6>
                <hr>
                <div>
                {% if work_plan_facilities_viz %}


                    {{ work_plan_facilities_viz|safe }}
                    {{ work_plan_areas_reviewed_viz|safe }}
                    {{ work_plan_actionpoint_status_viz|safe }}
                    {{ work_plan_timeframe_viz|safe }}
                    {{ work_plan_trend_viz|safe }}
                    {% endif %}

                </div>
                <div class="mt-2 " style="display:inline-block;">
                    <a href="{% url 'download_dqa_workplan' quarter_year selected_level %}" class="btn btn-info mb-4"
                       role="button">Download CSV</a>
                </div>
                <table class="table table-striped table-hover">
                    <thead class="thead-dark">
                    <th scope="col"></th>
                    <th scope="col">Facility</th>
                    <th scope="col">Gaps identified</th>
                    <th scope="col">Strengths Identified</th>
                    <th scope="col">Individuals Conducting DQA</th>
                    <th scope="col">Responsible person(s)</th>
                    <th scope="col">Recommendation</th>
                    <th scope="col">Comments</th>
                    </thead>
                    <tbody>
                    {% for action_plan in dqa_workplan %}
                        <tr>
                            <th scope="row">{{ forloop.counter }}</th>
                            <th scope="row">{{ action_plan.facility_name.name }}</th>
                            <td>
                                {{ action_plan.gaps_identified }}
                                <br>
                                <br>
                                <span style="font-size: 8px"
                                      class="badge alert-warning">Start date: {{ action_plan.dqa_date }}</span>
                                <span style="font-size: 8px"
                                      class="badge alert-info x-small">Due date: {{ action_plan.due_complete_by }}</span>
                                <br>
                                <span style="font-size: 8px"
                                      class="badge alert-warning">Program areas reviewed: {{ action_plan.program_areas_reviewed }}</span>
                            </td>
                            <td>
                                {{ action_plan.strengths_identified }}
                                <br>
                                <br>
                                <span style="font-size: 8px"
                                      class="badge alert-warning">Timeframe: {{ action_plan.timeframe|abs|add:"0" }} days</span>
                            </td>
                            <td>
                                {{ action_plan.individuals_conducting_dqa }}
                                <br>
                                <br>
                                <span style="font-size: 8px"
                                      class="badge alert-info">Percent completed: {{ action_plan.percent_completed }}%</span>
                            </td>
                            <td>
                                {{ action_plan.individuals_responsible }}
                                <br>
                                <br>
                                <span style="font-size: 8px"
                                      class="badge alert-warning">Last updated on: {{ action_plan.updated_at|date:"D j M Y H:i" }}</span>
                            </td>
                            <td>
                                {{ action_plan.recommendation }}
                                <br>
                                <br>
                                {% if action_plan.progress >= 0 and action_plan.percent_completed != 100 %}
                                    <span style="font-size: 8px"
                                          class="badge alert-info">Remaining time: {{ action_plan.progress|add:"0" }} days</span>
                                {% elif action_plan.progress < 0 and action_plan.percent_completed != 100 %}
                                    <span style="font-size: 8px"
                                          class="badge alert-danger">Overdue by: {{ action_plan.progress|add:"0" }} days</span>
                                {% else %}
                                    <span style="font-size: 8px"
                                          class="badge alert-success">Achieved: {{ action_plan.progress|abs }} days ago</span>

                                {% endif %}
                            </td>
                            <td>
                                {{ action_plan.comments }}
                            </td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
                <!-- Display the pagination links -->
                <div class="mt-3">
                    {% if action_plans.has_other_pages %}
                        <ul class="pagination justify-content-end">
                            {% if action_plans.has_previous %}
                                <li class="page-item"><a class="page-link"
                                                         href="?page={{ action_plans.previous_page_number }}">Prev</a>
                                </li>
                            {% else %}
                                <li class="disabled"><span class="page-link">Prev</span></li>
                            {% endif %}
                            {% for i in action_plans.paginator.page_range %}
                                {% if action_plans.number == i %}
                                    <li class="page-item active"><span class="page-link">{{ i }} <span class="sr-only">(current)</span></span>
                                    </li>
                                {% else %}
                                    <li class="page-item"><a class="page-link " href="?page={{ i }}">{{ i }}</a></li>
                                {% endif %}
                            {% endfor %}
                            {% if action_plans.has_next %}
                                <li class="page-item"><a class="page-link"
                                                         href="?page={{ action_plans.next_page_number }}">Next</a></li>
                            {% else %}
                                <li class="disabled page-item"><span class="page-link">Next</span></li>
                            {% endif %}
                        </ul>
                    {% endif %}
                </div>
            {% endif %}
        </div>
    </main>
{% endblock %}